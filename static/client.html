<!doctype html>
<html>
  <head>
    <title>ZuriHac plays</title>
  </head>
    <script type="text/JavaScript">
      /* This page is served on a URL like `/blah/:room-id/client`.  We use some
       * shity string matching to swap out the last part into something that
       * looks like `/blah/:room-id/events-sink`. */
      function eventsSinkUrlFromLocation() {
        var url = window.location.href;

        var i = url.lastIndexOf('/');
        url = url.substr(0, i) + '/events-sink';

        var i = url.indexOf(':');
        if(url.substr(0, i) == 'https') {
          url = 'wss' + url.substr(i);
        } else {
          url = 'ws' + url.substr(i);
        }

        return url;
      }

      /* Log some text. */
      function log(line) {
        var ul = document.getElementById('log');
        var li = document.createElement('li');
        li.textContent = line;
        if(ul.children.length > 20) {
          ul.removeChild(ul.children[0]);
        }
        ul.appendChild(li);
      }

      /* Connect to the events sink and spawn the 'zurihacPlays'. */
      function connectToEventsSink() {
        var url = eventsSinkUrlFromLocation();
        // var url = 'wss://echo.websocket.org/';
        var socket = null;
        var connected = false;

        function tryConnect() {
          if(!connected) {
            log('Attempting to connect to ' + url + '...');
            socket = new WebSocket(url);

            socket.addEventListener('open', function(event) {
              connected = true;
              log('Connected to server.');
            });

            socket.addEventListener('message', function(event) {
              log('-> ' + event.data);
            });

            socket.addEventListener('error', function(event) {
              log('There was error sorry');
            });

            socket.addEventListener('close', function(event) {
              connected = false;
              log('Connection closed: ' + event.reason);
              log('Reconnecting in 3s...');
              window.setTimeout(function() {
                tryConnect();
              }, 3000);
            });
          }
        }

        window.addEventListener('keydown', function(e) {
          e.preventDefault();
          var code = e.code;
          log('press ' + code);
          if(connected) {
            socket.send(JSON.stringify({
              'KeyPress': code
            }));
          }
          return false;
        });

        window.addEventListener('keyup', function(e) {
          e.preventDefault();
          var code = e.code;
          log('release ' + code);
          if(connected) {
            socket.send(JSON.stringify({
              'KeyRelease': code
            }));
          }
          return false;
        });

        tryConnect();
      }

      /* Start when the document's loaded. */
      document.onreadystatechange = function () {
        if(document.readyState == 'complete') {
          connectToEventsSink();
        }
      };
    </script>
    <style type="text/css">
      ul#log {
        font-family: monospace;
        list-style: none;
      }
    </style>
  <body>
    <ul id="log"></ul>
  </body>
</html>
